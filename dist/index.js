#!/usr/bin/env node
var L=Object.defineProperty;var l=(e,o)=>L(e,"name",{value:o,configurable:!0});var a=require("path"),p=require("fs"),{execSync:E}=require("child_process"),C=require("madge"),{OpenAI:O}=require("openai"),N=a.resolve(process.cwd(),".env");require("dotenv").config({path:N});var f=process.env.OPENAI_API_KEY||process.env.INPUT_OPENAI_API_KEY||"ollama",d=process.env.OPENAI_BASE_URL||"https://api.openai.com/v1",m=process.env.OPENAI_MODEL||"gpt-4o-mini";d.includes("openai.com")&&(!f||f==="ollama")&&(console.error("\u274C CRITICAL ERROR: OPENAI_API_KEY not found."),console.error("   If running locally, check your .env file."),console.error("   If running in GitHub Actions, ensure 'openai_api_key' is passed in 'with'."),process.exit(1));var S=new O({apiKey:f,baseURL:d}),_=15,v=500;function D(){if(process.env.GITHUB_ACTIONS){console.log("\u2601\uFE0F  Environment: GitHub Actions (CI)");try{let e=process.env.GITHUB_BASE_REF||"main";console.log(`   Comparing HEAD against origin/${e}...`);let o=`git diff --name-only origin/${e}...HEAD`;return E(o,{encoding:"utf8"}).split(`
`).filter(r=>r.trim()!=="")}catch(e){return console.error("\u26A0\uFE0F  CI Git Diff failed."),console.error("   HINT: Did you use 'fetch-depth: 0' in actions/checkout?"),console.error("   Error details:",e.message),[]}}console.log("\u{1F4BB} Environment: Local (Husky/Staging)");try{return E("git diff --cached --name-only --diff-filter=ACM",{encoding:"utf8"}).split(`
`).filter(o=>o.trim()!=="")}catch{return[]}}l(D,"getChangedFiles");function I(e){try{if(!p.existsSync(e))return!0;let i=p.readFileSync(e,"utf8").split(`
`).length;return i>v?(console.log(`\u26A0\uFE0F  Skipping ${a.basename(e)}: Too large (${i} lines).`),!0):!1}catch{return!0}}l(I,"isFileTooBig");async function k(){console.log(`\u{1F50C} Connected to LLM Provider: ${d.includes("openai.com")?"OpenAI Cloud":"Local/Custom"}`),console.log(`\u{1F916} Model: ${m}`),console.log("\u{1F575}\uFE0F  CommitRadar: Starting semantic scan...");let o=D().filter(n=>/\.(js|ts|jsx|tsx)$/.test(n));o.length===0&&(console.log("\u2705 No logical code changes detected. Approved."),process.exit(0)),o.length>_&&(console.log(`\u26A0\uFE0F  Massive change detected (${o.length} files).`),console.log("   Skipping AI analysis to protect budget/time."),process.exit(0)),console.log(`\u{1F9E0} Building dependency graph for ${o.length} files...`);let i={};try{i=(await C(".",{fileExtensions:["js","ts","jsx","tsx"],excludeRegExp:[/^node_modules/,/^\.git/]})).obj()}catch{console.error("\u26A0\uFE0F Error generating dependency graph. Skipping."),process.exit(0)}let r=!1;for(let n of o){if(I(n))continue;let h=a.basename(n,a.extname(n)),g=[];if(Object.keys(i).forEach(t=>{i[t].some(y=>y.includes(h))&&g.push(t)}),g.length===0)continue;let u=g.filter(t=>!I(t)).slice(0,2);if(u.length===0){console.log(`\u2139\uFE0F  ${n} affects files, but they are too complex to analyze. Skipping.`);continue}console.log(`\u26A1 Analyzing impact of '${n}' on: ${u.join(", ")}`);let A=p.readFileSync(n,"utf8"),s=`You are a strict CI/CD Guardian.
`;s+=`Your Goal: Detect if the change in the MODIFIED FILE breaks logic or types in the DEPENDENT FILES.

`,s+=`--- MODIFIED FILE: ${n} ---
${A}

`,u.forEach(t=>{s+=`--- DEPENDENT FILE: ${t} ---
${p.readFileSync(t,"utf8")}

`}),s+=`INSTRUCTIONS:
`,s+=`1. Look for type incompatibilities (e.g., Number vs String).
`,s+=`2. Look for broken function signatures or missing exports.
`,s+=`3. Respond ONLY with valid JSON in this format:
`,s+='{ "verdict": "APPROVED" | "REJECTED", "risk": "LOW" | "CRITICAL", "reason": "Brief technical explanation (1 sentence)" }';try{let t=await S.chat.completions.create({messages:[{role:"user",content:s}],model:m,response_format:{type:"json_object"},temperature:0}),c=JSON.parse(t.choices[0].message.content);console.log(`\u{1F916} Analysis for ${n}:`),console.log(`   Risk:   ${c.risk}`),console.log(`   Reason: ${c.reason}
`),(c.verdict==="REJECTED"||c.risk==="CRITICAL")&&(r=!0)}catch(t){console.error("\u26A0\uFE0F AI Analysis failed:",t.message)}}r?(console.error(`
\u274C AUTOMATIC BLOCK: Critical risks detected.`),process.exit(1)):(console.log("\u2705 All clear."),process.exit(0))}l(k,"analyze");k();
